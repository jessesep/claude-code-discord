# Claude Code Discord Bot ‚Äî Agent Context (Root)
> **MANDATORY READ**: Agents MUST read this file and the nearest compartment `.agent-context.md` before editing code. Keep changes minimal, safe, and testable.

## üéØ Project Mission
Run a Discord bot that provides a **Manager ‚Üí Subagent** workflow for coding tasks, using:
- **Antigravity (Gemini)** for the manager/orchestrator and some agents
- **Cursor CLI** for autonomous code editing agents
- **Claude CLI / Anthropic API** for certain flows (varies by command/client)

## üß≠ Current State Snapshot (Jan 2026)
- **Runtime**: Deno + TypeScript (Deno tasks in `deno.json`)
- **Bot entrypoint**: `index.ts`
- **Discord UX**: simplified primary commands are `/run`, `/kill`, `/help` (other handlers still exist but are not registered by default)
- **Web server**: `server/index.ts` is started automatically (default port **8000**) from `index.ts`
- **Persistence**: `./data/settings.json` via `util/settings-persistence.ts` (not DB-backed)
- **Tests**: ad-hoc scripts live under `tests/` (not currently enforced by CI)

## üèóÔ∏è Compartment Map (Core)
- `/agent/`: orchestration, sessions, manager handoffs, `PREDEFINED_AGENTS`
- `/discord/`: Discord gateway, command registration, embeds, pagination, formatting
- `/claude/`: LLM clients (Gemini SDK + Cursor CLI + Claude tooling glue)
- `/git/`: git/worktree automation + worktree bot process management
- `/server/` + `/dashboard/`: Hono API + static dashboard
- `/settings/` + `/util/`: settings models + persistence + shared utilities

## üîê Critical Limitations / Risks (track in GitHub Issues)
If you touch these areas, prioritize fixes and add tests.
- **[CRITICAL] Unauthenticated settings API + potential secret leakage**: issue **#63**
- **[HIGH] Webhooks lack signature/secret verification**: issue **#64**
- **[HIGH] Cursor `stream-json` parsing likely mismatched to actual event schema**: issue **#65**
- **[MEDIUM] Startup clears global Discord commands**: issue **#67**
- **[MEDIUM] No CI workflows**: issue **#66**
- **Security backlog already exists**: path traversal / rate limiting / RBAC / prompt injection / hooks audit (#1‚Äì#3, #39‚Äì#57, etc.)

## ‚úÖ Need-to-haves (near-term)
- Lock down `/api/*` with auth + redaction (and make the web server opt-in / bind localhost)
- Add CI (fmt/lint/check/tests) and make it gate PRs
- Fix Cursor streaming parser + add tests for NDJSON parsing
- Implement webhook signature verification + replay protection

## ‚ú® Want-to-haves (later)
- Proper session persistence (current agent sessions are in-memory)
- Better observability (structured logs, request IDs, metrics)
- Clear deploy/run modes (separate ‚Äúdeploy commands‚Äù from runtime)

## üîß Required / Common Environment Variables
Documentation/templates may be incomplete; key vars used by code include:
- `DISCORD_TOKEN`, `APPLICATION_ID`
- `OWNER_ID` (preferred) or `DEFAULT_MENTION_USER_ID` (used for authorization checks)
- `GEMINI_API_KEY` or `GOOGLE_API_KEY` (Antigravity via Gemini SDK)
- `ANTHROPIC_API_KEY` (some Anthropic API provider paths)
- Optional: `CATEGORY_NAME`

## ‚öñÔ∏è Rules of Engagement
1. **Respect hierarchy**: read the nearest `.agent-context.md` before editing a compartment.
2. **Safety first**: don‚Äôt introduce or widen unauthenticated remote surfaces.
3. **Prefer small diffs**: ship incremental fixes with tests.
