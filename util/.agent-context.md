# Utility Compartment Context
> **Scope**: Cross-cutting concerns, system bridges, and helper services.

## ðŸŽ¯ Mission
Provide shared logic and platform integrations. This compartment acts as the bridge between core agent logic and external systems like Git, GitHub, and the `claude-mem` memory engine.

## ðŸ—ºï¸ Key Filepaths
- `util/claude-mem-service.ts`: Primary bridge for interacting with the `claude-mem` worker API.
- `util/github-issues.ts`: Logic for parsing and creating GitHub issues via the API.
- `util/mcp-server.ts`: Registration and handling for internal MCP tools.
- `util/swarm-manager.ts`: Orchestration for multi-agent workflows (creating channels/categories).
- `util/settings-persistence.ts`: File-based storage for user-specific and system-wide settings.
- `util/list-models.ts`: Model caching, resolution, and fallback chain management.
- `util/testing-mode.ts`: Testing mode configuration and bypass flags.

## ðŸ› ï¸ Key Dependencies
- `octokit`: For GitHub API interactions.
- `node-fetch`: For worker API communication.

## ðŸ“œ Conventions
- **Error Resilience**: Use the `handleGlobalError` pattern to prevent crashes from external API failures.
- **Path Neutrality**: Use utility functions to resolve filepaths across different operating systems/working directories.
- **Service Isolation**: Wrap complex external integrations (like GitHub) in dedicated service classes.

## ðŸ’¡ Code Example: Memory Search Bridge
```typescript
export async function searchProjectHistory(query: string, project: string) {
  const service = new ClaudeMemService();
  return await service.search({ query, project });
}
```

## ðŸ†• Model Management (Jan 2026)

### Model Caching & Resolution (`list-models.ts`)
```typescript
// Get cached models (auto-refreshes hourly)
const models = await getCachedModels();

// Resolve model name (adds -preview suffix if needed)
const resolved = await resolveModelName('gemini-3-flash');
// Returns: 'gemini-3-flash-preview'

// Client-specific mapping
const cursorModel = resolveModelForClient('gemini-3-flash-preview', 'cursor');
// Returns: 'gemini-3-flash' (Cursor uses different naming)
```

### Model Fallback Chain
```typescript
// Get fallback chain for a model
const chain = getFallbackChain('gemini-3-flash-preview');
// Returns: ['gemini-3-flash-preview', 'gemini-2.5-flash', 'gemini-2.0-flash']

// Execute with automatic fallback on 429/503/404
const result = await executeWithFallback(
  'gemini-3-flash-preview',
  async (model) => await callProvider(model),
  (from, to, err) => console.log(`Fallback: ${from} -> ${to}`)
);
```

**GOLDEN RULE**: Fallbacks must be same-generation or newer, NEVER older.

### Testing Mode (`testing-mode.ts`)
```typescript
import { isTestingMode, enableTestingMode } from './testing-mode.ts';

// Check if testing mode is enabled
if (isTestingMode().enabled) {
  // Bypass approvals, sandbox, channel restrictions
}

// Enable programmatically
enableTestingMode({ quiet: true });
```
