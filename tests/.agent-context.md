# Tests Compartment Context
> **Scope**: End-to-end testing, integration tests, and testing utilities.

## üéØ Mission
Provide robust end-to-end testing infrastructure for the one agent discord system. Tests validate agent behavior, Discord integration, and multi-provider operations.

## üó∫Ô∏è Key Filepaths
- `tests/e2e-utils.ts`: Core testing utilities - `withTestContext()`, `spawnAgent()`, `TEST_CHANNELS`
- `tests/e2e-basic.ts`: Basic agent interaction tests
- `tests/e2e-git.ts`: Git operation tests (branch create/delete)
- `tests/e2e-shell.ts`: Shell command execution tests
- `tests/e2e-multi-file.ts`: Multi-file operation tests
- `tests/e2e-orchestration.ts`: Manager-subagent orchestration tests
- `tests/e2e-error-recovery.ts`: Error handling and recovery tests
- `tests/test-agent-isolation.ts`: Agent instance isolation verification (41 tests)

## üõ†Ô∏è Key Dependencies
- `discord.js`: For Discord client in tester bot
- `e2e-utils.ts`: Core testing framework

## üìú Conventions

### Test Structure
```typescript
import { withTestContext, spawnAgent } from './e2e-utils.ts';

async function runMyTest() {
  return await withTestContext('e2e-basic', async (ctx) => {
    const result = await spawnAgent(
      ctx,
      'cursor-coder',
      'Your task here...',
      { timeout: 60000, useBudget: true }
    );
    
    if (!result.success) throw new Error(result.error);
    
    // Verify result
    return { success: true, message: 'Test passed' };
  });
}
```

### Test Channels
All E2E tests should use dedicated channels in `[TESTING] one agent bot` category:
| Channel | Purpose |
|---------|---------|
| `e2e-basic` | Basic operations, fallback for others |
| `e2e-multi-file` | Multi-file operations |
| `e2e-error-recovery` | Error handling |
| `e2e-orchestration` | Manager/subagent flows |

### Running Tests
```bash
# Single test
deno run --allow-all tests/e2e-basic.ts

# Agent isolation tests
deno test --allow-all tests/test-agent-isolation.ts
```

## üêõ Historical Bugs (Don't Repeat)

### Bug #127: Git Branch Deletion Failure
**Cause**: Single complex prompt with multiple git operations failed silently.
**Fix**: Split into two separate prompts with verification between steps.
**Lesson**: For multi-step operations, use separate prompts and verify intermediate state.

### Bug #126: Test Suite Timeouts
**Cause**: Hardcoded timeouts too short for complex operations.
**Status**: Open - needs event-driven completion detection.

## üí° Best Practices

1. **Split Complex Operations**: Use multiple `spawnAgent()` calls with verification between steps
2. **Explicit Commands**: Use exact shell/git commands in prompts, not abstract descriptions
3. **Timeout Handling**: Use appropriate timeouts (120s+ for complex operations)
4. **Cleanup**: `withTestContext()` handles cleanup automatically - always use it
5. **Model Selection**: Use `useBudget: true` to use fast models for testing

## üÜï Recent Improvements (Jan 2026)

### E2E Git Test Fix (#127)
Split git operations into two steps:
```typescript
// Step 1: Create branch
await spawnAgent(ctx, 'cursor-coder', 
  `Execute: git checkout -b ${branchName}`);

// Verify branch exists
await verifyBranchExists(branchName);

// Step 2: Delete branch (separate prompt)
await spawnAgent(ctx, 'cursor-coder',
  `Execute: git branch -D ${branchName}`);
```

### Agent Instance Isolation
Verified with 41 tests in `test-agent-isolation.ts`:
- Unique instance IDs per channel
- Hard channel binding
- Isolated context windows
- No crosstalk between agents
